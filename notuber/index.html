<!DOCTYPE html>

<html>

	<head>
		<title>Not Uber</title>
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=true&libraries=geometry"></script>.
		<link rel="stylesheet" href="main.css" />
		
		<script>
			var myLat = 0;
			var myLng = 0;
			console.log("send lat/long0 = " + myLat + "," + myLng);			
			var request = new XMLHttpRequest();
			var me = new google.maps.LatLng(myLat, myLng);

			var myOptions = {
						zoom: 13, // The larger the zoom number, the bigger the zoom
						center: me,
						mapTypeId: google.maps.MapTypeId.ROADMAP
					};
			var map;
			var marker;
			var infowindow = new google.maps.InfoWindow();
			


			function init()
			{
				map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
				getMyLocation();
			}
			
			function getMyLocation() {
				if (navigator.geolocation) { // the navigator.geolocation object is supported on your browser
					navigator.geolocation.getCurrentPosition(function(position) {
						myLat = position.coords.latitude;
						myLng = position.coords.longitude;
						console.log(myLat + "," + myLng);
						accessData();
						//renderMap();
					});
				}

				else {
					alert("Geolocation is not supported by your web browser.  What a shame!");
				}

			}
			function accessData() 
			{
				var username = "9SO147Xl";
				var xhr = new XMLHttpRequest();
				xhr.open('POST', "https://defense-in-derpth.herokuapp.com/submit", true);
				xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
				xhr.onload = function () {
				    // do something to response
				    carData = JSON.parse(this.responseText);
				    if(carData["vehicles"]){
				    	console.log("test");
				    	console.log(carData["vehicles"][0]);
				    	console.log("content " + carData["vehicles"][0].lat)
				    	renderMapVehicles(carData)
					}
					else if(carData["passengers"]){
				    console.log("test2");
					}
				};
				xhr.send("username=" + username + "&lat=" + myLat + "&lng=" + myLng);

			}
			//renders the map of vehicles when my username is a passenger
			function renderMapVehicles(carData)
			{
				//create a marker for my location
				createMyMarker(carData);
				// Create a markers for all the data
				for(var i = 0; i<carData["vehicles"].length; i++){
					createMarkerVehicles(carData, i);
				}
			}
			function createMyMarker(carData){
				me = new google.maps.LatLng(myLat, myLng);
				
				// Update map and go there...
				map.panTo(me);
	
				//Marker for my position
				marker = new google.maps.Marker({
					position: me,
					title: "Here I am!"
				})
				marker.setMap(map);
				google.maps.event.addListener(marker, 'click', function() {
					infowindow.setContent(marker.title);
					infowindow.open(map, marker);
				});
			}
			function createMarkerVehicles(carData, i){
						carPos = new google.maps.LatLng(carData["vehicles"][i].lat, carData["vehicles"][i].lng);
						distance = findDist(carData["vehicles"][i].lat, carData["vehicles"][i].lng);

						var marker = new google.maps.Marker({
							position: carPos,
							title: carData["vehicles"][i].username + " (" + distance + " mi)"
						});
						marker.setMap(map);

						google.maps.event.addListener(marker, 'click', function() {
						infowindow.setContent(marker.title);
						infowindow.open(map, marker);
						});
			}
			function findDist(carLat, carLng){
				distMeters = google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(myLat, myLng), new google.maps.LatLng(carLat, carLng))*0.000621371;
				distMeters = Math.round(distMeters * 100) / 100
				console.log("Difference: " + distMeters);
				return distMeters;
			}
		</script>
	</head>
	
	<body onload="init()">
		<div id="map_canvas"></div>
	</body>
</html>